Ватериус поддерживает отправку в
- сайт <a href="https://waterius.ru" target="_blank">waterius.ru</a>
- MQTT
- HTTP
- приложение Blynk

# Список параметров
В таблице собрана информация об отправляемых данных. В столбцах HTTP, MQTT, Blynk указано, отправляются ли данные по соответствующему протоколу. В столбце Blynk указан номер виртуального пина в который записывается поле.

| Поле | Размерность | Тип | Описание | HTTP | MQTT | Blynk | 
| --- | --- | --- | --- | --- | --- | --- |
| imp0 | шт | uint | Количество импульсов | + | + | V0 | 
| imp1 | шт | uint | Количество импульсов | + | + | V1 | 
| delta0 | литр | uint | Разница с предыдущими показаниями, вход 0 (гор. вода) | + | + | V3 | 
| delta1 | литр | uint | Разница с предыдущими показаниями, вход 1 (хол. вода) | + | + | V4 | 
| ch0 | м3 | float | Показания воды, вход 0 | + | + | - |
| ch1 | м3 | float | Показания воды, вход 1 | + | + | - |
| adc0 | - | uint | Аналоговый уровень входа 0 | + | + | - |
| adc1 | - | uint | Аналоговый уровень входа 1 | + | + | - |
| good | - | uint | Получены данные от attiny85. Всегда 1. | + | + | - |
| boot | - | uint | Причина загрузки attiny85 | + | + | - |
| version | - | int | Версия прошивки attiny85 | + | + | - |
| version_esp | - | str | Версия прошивки esp | + | + | - |
| key | - | str | Уникальный токен | + | - | - |
| resets | шт | uint | Количество перезагрузок | + | + | V5 |
| email | - | str | Электронная почта | + | + | - |
| voltage | В | float | Напряжение питания attiny85 | + | + | V2 |
| voltage_diff | мВ | int | Просадка напряжения за время подключения Wi-Fi | + | + | V7 |
| voltage_low | 0 или 1 | int | voltage_diff выше 50мВ  | + | + | V6 (светодиод) |
| f0 | - | uint | Вес импульса, вход 0 | + | + | - |
| f1 | - | uint | Вес импульса, вход 1 | + | + | - |
| rssi | dBm | int | Уровень Wi-Fi сигнала | + | + | V8 |
| waketime | мсек | int | Время работы ESP при предыдущем включении | + | + | - |
| setuptime | мсек | int | Длительность режима настройки | + | + | - |
| period_min | минуты | uint | Период пробуждения | + | + | - |
| serial0 | - | str | Серийный номер, вход 0 | + | + | - |
| serial1 | - | str | Серийный номер, вход 1 | + | + | - |
| mode | - | int | 1-настройка, 2-передача по таймеру, 3-передача по кнопке | + | + | - |
| setup_finished | - | int | Счётчик успешного завершения настройки | + | + | - |
| setup_started | - | int | Счётчик начала настройки | + | + | - |
| channel | - | int | Номер wi-fi канала роутера | + | + | - |
| mac | - | int | 3 байта MAC <a href="https://gist.github.com/aallan/b4bb86db86079509e6159810ae9bd3e4">адреса роутера</a>  | + | + | - |

В версии 4C2W + delta2, delta3 и т.п.

# Настройка отправки на сайт waterius.ru
Зарегистрируйтесь на сайте waterius.ru по адресу электронной почты.
Заполните в режиме настройки:
| Поле | Описание | Пример | Обязательно |
| --- | --- | --- | --- |
| Электронная почта с сайта waterius.ru | Указанная при регистрации почта | user@mail.ru | + |

Ватериус появится в личном кабинете при отправке показаний.

# Настройка отправки по MQTT 
Заполните в режиме настройки:
| Поле | Описание | Пример | Обязательно |
| --- | --- | --- | --- |
| Адрес сервера | ip адрес брокера или домен | 192.168.1.10, broker.hivemq.com | + |
| Порт | порт брокера | 1883 | + |
| Логин | логин для авторизированного доступа | username | - |
| Пароль | пароль для авторизированного доступа | secret | - |
| Топик | топик по которому будут отсылаться данные | waterius/123456/ | + |

Заполненное поле "Адрес сервера" включает отправку по протоколу MQTT.
Для подключения нескольких ватериусов укажите им разные топики.

Данные отправляются с retain=true

<a href="https://github.com/dontsovcmc/waterius/wiki/%D0%9F%D1%80%D0%B8%D0%BC%D0%B5%D1%80-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B-%D0%BF%D0%BE-MQTT">Пример работы по MQTT</a>

# Настройка отправки по HTTP (свой сервер)

Заполните в режиме настройки:
| Поле | Описание | Пример | Обязательно |
| --- | --- | --- | --- |
| Адрес сервера | ip адрес сервера или домен (```http[s]://host[:port][/path]```) | 192.168.1.10, http://mysite.ru, http://mysite.ru:1000/data | + |

Если "Адрес сервера" пустой, отправка по HTTP выключена.

Ватериус отправляет POST запрос с данными в виде JSON.

<a href="https://github.com/dontsovcmc/waterius/wiki/%D0%9F%D1%80%D0%B8%D0%BC%D0%B5%D1%80-%D0%B2%D0%B5%D0%B1%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0">Пример вебсервера</a>

## Поддержка HTTPS 

Начиная с версии 6.0 добавлена библиотека BearSSL с поддержкой TLS 1.2 шифрования.
В веб интерфейсе укажите в Адресе сервера "https".
Поддерживается проверка сертификата сервера при помощи сертификата удостоверяющего центра.
В прошивку добавлен сертификат [Let's encrypt](https://letsencrypt.org/certificates/), т.е. Ватериус будет доверять вашему сайту, если ему выдал сертификат Let's encrypt. Инструкция по созданию сертификатов в [Python скрипте]. У сертификатов есть срок действия.

# Настройка отправки в Blynk на телефон

1. Установите приложение <a href="https://github.com/dontsovcmc/waterius/wiki/%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F-Blynk">по инструкции</a> и скопируйте ключ из приложения в буфер.

Заполните в режиме настройки:
| Поле | Описание | Пример | Обязательно |
| ---- | ---- | ---- | ---- |
| Адрес сервера | blynk-cloud.com или локальный | + |
| Уникальный ключ | Вставьте из буфера обмена ключ из приложения Blynk. | | + |
| Адрес эл. почты | Blynk будет отправлять письмо каждые сутки | - |
| Заголовок | Заголовок эл. письма. {V0} - {V7} будут заменены на данные. Ограничение строки 64 символа. | Гор. вода {V0} <br>Хол. вода {V1} | - |
| Тело письма | Содержание. {V0} - {V7} будут заменены на данные. Ограничение строки 200 символов.  | Показания счетчиков воды | - |

Если "Уникальный ключ" не заполнен, то отправка в Blynk выключена.
Для отправки ежедневных писем, заполните "Адрес эл. почты", а также добавьте виджет "эл. почта" в приложении.


# Проекты сообщества
* [httpwaterius](https://github.com/grffio/httpwaterius) - web сервер с простым UI от [grffio](https://github.com/grffio)
